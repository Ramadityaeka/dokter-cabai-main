<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch The Puzzle - Final Version (Bug Free)</title>
    <style>
        /* CSS tidak ada perubahan */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Arial', sans-serif; display: flex; justify-content: center; align-items: center; flex-direction: column; min-height: 100vh; padding: 20px; margin: 0; background: linear-gradient(135deg, #6ab1ea 0%, #1b5dab 100%); overflow: hidden; color: white; }
        h1 { color: #fff; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); font-size: 2.8rem; margin-bottom: 10px; letter-spacing: 1px; text-align: center; margin-top: 15px; }
        .game-header { display: flex; justify-content: space-between; align-items: center; width: 500px; margin-bottom: 15px; }
        #score-board { font-size: 28px; font-weight: bold; background: rgba(0, 0, 0, 0.3); padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        #speed-indicator { font-size: 20px; background: rgba(0, 0, 0, 0.3); padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease; }
        #game-container { position: relative; width: 500px; height: 600px; border: 5px solid #654321; background: linear-gradient(to bottom, #a3d5ff 0%, #7bc1ff 100%); overflow: hidden; box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4); border-radius: 12px; }
        #platform { position: absolute; width: 120px; height: 20px; background: linear-gradient(to bottom, #a86a32 0%, #8B4513 100%); border: 2px solid #5a2d0c; bottom: 10px; left: 0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .puzzle-piece { position: absolute; width: 50px; height: 50px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M38,16 A12,12 0 0,1 62,16 L75,16 A8,8 0 0,1 83,24 L83,38 A12,12 0 0,0 83,62 L83,75 A8,8 0 0,1 75,83 L62,83 A12,12 0 0,1 38,83 L25,83 A8,8 0 0,1 17,75 L17,62 A12,12 0 0,0 17,38 L17,25 A8,8 0 0,1 25,16 L38,16 Z' fill='%23FFA500' stroke='%23D2691E' stroke-width='5'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; transition: filter 0.3s ease, opacity 0.3s ease, transform 0.2s ease; will-change: transform, filter, opacity; }
        .is-silhouette { filter: brightness(0) opacity(0.5); }
        .is-hologram { opacity: 0.7; animation: hologram-effect 1.5s infinite alternate; }
        @keyframes hologram-effect { 0% { opacity: 0.5; transform: translateY(0); } 50% { opacity: 0.85; transform: translateY(-2px); } 100% { opacity: 0.6; transform: translateY(0); } }
        .caught { animation: caught-animation 0.4s forwards; }
        @keyframes caught-animation { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(0); opacity: 0; } }
        #game-over-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.95) 100%); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10; backdrop-filter: blur(4px); }
        #game-over-text { font-size: 4.5rem; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 15px #ff5555; animation: game-over-pulse 1.5s infinite alternate; }
        @keyframes game-over-pulse { from { transform: scale(1); text-shadow: 0 0 10px #ff5555; } to { transform: scale(1.05); text-shadow: 0 0 25px #ff5555, 0 0 15px #ff0000; } }
        #final-score { font-size: 2.5rem; margin-bottom: 30px; }
        #restart-button { font-size: 1.3rem; padding: 15px 45px; margin-top: 20px; cursor: pointer; border: none; background: linear-gradient(to right, #ff8c00, #ff5500); color: white; border-radius: 50px; font-weight: bold; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s ease; }
        #restart-button:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); background: linear-gradient(to right, #ff9c20, #ff6600); }
        #restart-button:active { transform: translateY(1px); box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); }
        .controls { display: flex; gap: 20px; margin-top: 20px; }
        .control-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(0, 0, 0, 0.3); display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2); transition: all 0.2s; border: 2px solid rgba(255, 255, 255, 0.5); }
        .control-btn:active { transform: scale(0.95); background: rgba(0, 0, 0, 0.5); }
        .instructions { margin-top: 25px; background: rgba(0, 0, 0, 0.2); padding: 15px 30px; border-radius: 15px; max-width: 500px; text-align: center; font-size: 1.1rem; line-height: 1.6; }
        .bubble { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.15); animation: float 8s infinite ease-in-out; }
        @keyframes float { 0% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 0.5; } 90% { opacity: 0.3; } 100% { transform: translateY(-700px) translateX(20px); opacity: 0; } }
        @media (max-width: 550px) { #game-container, .game-header { width: 95vw; max-width: 500px; } #game-container { height: 80vh; max-height: 600px; } h1 { font-size: 2.2rem; } .instructions { width: 95vw; font-size: 1rem; } }
    </style>
</head>
<body>
    <h1>Catch The Puzzle!</h1>
    <div class="game-header"><div id="score-board">Skor: 0</div><div id="speed-indicator">Kecepatan: 1.0x</div></div>
    <div id="game-container"><div id="platform"></div></div>
    <div class="controls"><div class="control-btn" id="left-btn">◄</div><div class="control-btn" id="right-btn">►</div></div>
    <div class="instructions">Tangkap potongan puzzle sebelum jatuh! Gunakan tombol panah ◄ ► atau tombol di layar untuk bergerak. Kecepatan akan meningkat!</div>
    <div id="game-over-screen"><div id="game-over-text">GAME OVER</div><div id="final-score">Skor Akhir: 0</div><button id="restart-button">MULAI LAGI</button></div>

    <script>
        const DOM = { gameContainer: document.getElementById('game-container'), platform: document.getElementById('platform'), scoreBoard: document.getElementById('score-board'), speedIndicator: document.getElementById('speed-indicator'), gameOverScreen: document.getElementById('game-over-screen'), finalScore: document.getElementById('final-score'), restartButton: document.getElementById('restart-button'), leftBtn: document.getElementById('left-btn'), rightBtn: document.getElementById('right-btn'), };
        const state = { score: 0, platformX: 0, platformSpeed: 350, fallSpeed: 120, isGameOver: false, animationFrameId: null, puzzleSpawnerId: null, lastTimestamp: 0, isMovingLeft: false, isMovingRight: false, };
        const config = { spawnInterval: 1800, baseFallSpeed: 120, puzzleWidth: 50, spawnPadding: 10, };

        function createPuzzlePiece() {
            if (state.isGameOver) return;
            const puzzle = document.createElement('div');
            puzzle.classList.add('puzzle-piece');
            puzzle.dataset.visualState = 'silhouette';
            puzzle.classList.add('is-silhouette');
            const spawnAreaWidth = DOM.gameContainer.offsetWidth - config.puzzleWidth - (config.spawnPadding * 2);
            const randomOffset = Math.floor(Math.random() * spawnAreaWidth);
            puzzle.style.left = `${config.spawnPadding + randomOffset}px`;
            puzzle.style.top = '-50px';
            DOM.gameContainer.appendChild(puzzle);
        }

        function updatePlatformPosition(deltaTime) {
            const distance = state.platformSpeed * deltaTime;
            if (state.isMovingLeft) state.platformX -= distance;
            if (state.isMovingRight) state.platformX += distance;
            state.platformX = Math.max(0, Math.min(state.platformX, DOM.gameContainer.offsetWidth - DOM.platform.offsetWidth));
            DOM.platform.style.transform = `translateX(${state.platformX}px)`;
        }
        
        function gameLoop(timestamp) {
            if (state.isGameOver) return;
            if (!state.lastTimestamp) state.lastTimestamp = timestamp;
            const deltaTime = (timestamp - state.lastTimestamp) / 1000;
            state.lastTimestamp = timestamp;
            updatePlatformPosition(deltaTime);

            const puzzles = document.querySelectorAll('.puzzle-piece');
            const gameHeight = DOM.gameContainer.offsetHeight;
            const adjustedFallSpeed = state.fallSpeed * deltaTime;
            const hologramZoneStart = gameHeight / 3;
            const fullColorZoneStart = (gameHeight / 3) * 2.2;
            
            puzzles.forEach(puzzle => {
                // --- PERBAIKAN BUG UTAMA: Abaikan puzzle yang sudah ditangkap ---
                if (puzzle.classList.contains('caught')) {
                    return; // Lewati puzzle ini, jangan proses lebih lanjut
                }

                let puzzleTop = parseFloat(puzzle.style.top || -50);
                puzzleTop += adjustedFallSpeed;
                puzzle.style.top = `${puzzleTop}px`;
                
                const currentState = puzzle.dataset.visualState;
                let newState = currentState;
                if (puzzleTop < hologramZoneStart) { newState = 'silhouette'; } 
                else if (puzzleTop < fullColorZoneStart) { newState = 'hologram'; } 
                else { newState = 'full-color'; }
                if (currentState !== newState) {
                    puzzle.dataset.visualState = newState;
                    puzzle.classList.toggle('is-silhouette', newState === 'silhouette');
                    puzzle.classList.toggle('is-hologram', newState === 'hologram');
                }
                
                const isCaught = (puzzleTop > gameHeight - 60) && (() => {
                    const puzzleRect = puzzle.getBoundingClientRect();
                    const platformRect = DOM.platform.getBoundingClientRect();
                    return puzzleRect.bottom >= platformRect.top && puzzleRect.left < platformRect.right && puzzleRect.right > platformRect.left && puzzleRect.bottom < platformRect.bottom + 20;
                })();

                if (isCaught) {
                    puzzle.classList.add('caught'); // Tandai puzzle ini sebagai 'tertangkap'
                    setTimeout(() => puzzle.remove(), 400);
                    state.score++;
                    DOM.scoreBoard.textContent = 'Skor: ' + state.score;
                    if (state.score > 0 && state.score % 5 === 0) {
                        state.fallSpeed += 20;
                        DOM.speedIndicator.textContent = `Kecepatan: ${(state.fallSpeed / config.baseFallSpeed).toFixed(1)}x`;
                        DOM.speedIndicator.style.transform = 'scale(1.15)';
                        setTimeout(() => DOM.speedIndicator.style.transform = 'scale(1)', 300);
                    }
                } else if (puzzleTop > gameHeight) {
                    puzzle.remove(); 
                    endGame();
                }
            });
            state.animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function endGame() { if (state.isGameOver) return; state.isGameOver = true; cancelAnimationFrame(state.animationFrameId); clearInterval(state.puzzleSpawnerId); DOM.gameOverScreen.style.display = 'flex'; DOM.finalScore.textContent = 'Skor Akhir: ' + state.score; }
        function startGame() { state.isGameOver = false; state.score = 0; state.fallSpeed = config.baseFallSpeed; state.platformX = (DOM.gameContainer.offsetWidth - DOM.platform.offsetWidth) / 2; DOM.platform.style.transform = `translateX(${state.platformX}px)`; DOM.scoreBoard.textContent = 'Skor: 0'; DOM.speedIndicator.textContent = 'Kecepatan: 1.0x'; DOM.gameOverScreen.style.display = 'none'; DOM.gameContainer.querySelectorAll('.puzzle-piece, .bubble').forEach(el => el.remove()); createBubbles(); cancelAnimationFrame(state.animationFrameId); clearInterval(state.puzzleSpawnerId); state.lastTimestamp = 0; state.animationFrameId = requestAnimationFrame(gameLoop); state.puzzleSpawnerId = setInterval(createPuzzlePiece, config.spawnInterval); }
        function createBubbles() { for (let i = 0; i < 8; i++) { const bubble = document.createElement('div'); bubble.classList.add('bubble'); const size = Math.random() * 40 + 10; bubble.style.width = `${size}px`; bubble.style.height = `${size}px`; bubble.style.left = `${Math.random() * 100}%`; bubble.style.animation = `float ${Math.random() * 5 + 8}s infinite ease-in-out ${Math.random() * 10}s`; DOM.gameContainer.appendChild(bubble); } }
        
        function setupEventListeners() {
            const keyMap = { 'ArrowLeft': 'left', 'ArrowRight': 'right' };
            window.addEventListener('keydown', (e) => { if (e.key in keyMap) state[`isMoving${keyMap[e.key].charAt(0).toUpperCase() + keyMap[e.key].slice(1)}`] = true; });
            window.addEventListener('keyup', (e) => { if (e.key in keyMap) state[`isMoving${keyMap[e.key].charAt(0).toUpperCase() + keyMap[e.key].slice(1)}`] = false; });
            const setupButtonEvents = (button, direction) => {
                const stateProp = `isMoving${direction.charAt(0).toUpperCase() + direction.slice(1)}`;
                ['mousedown', 'touchstart'].forEach(type => button.addEventListener(type, (e) => { e.preventDefault(); state[stateProp] = true; }, { passive: true }));
                ['mouseup', 'mouseleave', 'touchend'].forEach(type => button.addEventListener(type, () => state[stateProp] = false));
            };
            setupButtonEvents(DOM.leftBtn, 'left');
            setupButtonEvents(DOM.rightBtn, 'right');
            DOM.restartButton.addEventListener('click', startGame);
        }
        
        setupEventListeners();
        startGame();
    </script>
</body>
</html>